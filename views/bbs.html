<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>掲示板</title>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet" />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              discord: {
                light: "#f2f3f5",
                dark: "#36393f",
                darker: "#2f3136",
                sidebar: "#202225",
              },
            },
          },
        },
      };
    </script>
    <style>
      .message-container {
        height: calc(100vh - 240px);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f2f3f5;
      }

      .dark .message-container {
        scrollbar-color: #4a4d52 #2f3136;
      }

      .message-container::-webkit-scrollbar {
        width: 8px;
      }

      .message-container::-webkit-scrollbar-track {
        background: #f2f3f5;
      }

      .dark .message-container::-webkit-scrollbar-track {
        background: #2f3136;
      }

      .message-container::-webkit-scrollbar-thumb {
        background-color: #cbd5e0;
        border-radius: 4px;
      }

      .dark .message-container::-webkit-scrollbar-thumb {
        background-color: #4a4d52;
      }

      .message {
        transition: background-color 0.2s ease;
      }

      .message:hover {
        background-color: #f8fafc;
      }

      .dark .message:hover {
        background-color: #32353b;
      }

      .deleted-message {
        border: 1px solid #ff6b6b;
        background-color: #fff5f5;
      }

      .dark .deleted-message {
        border-color: #a33;
        background-color: #3a2f2f;
      }

      .deleted-message:hover {
        background-color: #ffe3e3;
      }

      .dark .deleted-message:hover {
        background-color: #3f3535;
      }

      .message-input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #f2f3f5;
        padding: 1.25rem;
        border-top: 1px solid #e5e7eb;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }

      .dark .message-input-container {
        background-color: #36393f;
        border-top-color: #202225;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
      }

      /* モーダル関連のスタイルを追加 */
      .modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 50;
      }

      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        padding: 2rem;
        border-radius: 0.5rem;
        z-index: 51;
        width: 90%;
        max-width: 500px;
      }

      .dark .modal {
        background-color: #36393f;
        border: 1px solid #202225;
      }
    </style>
  </head>
  <body
    class="bg-discord-light dark:bg-discord-dark text-gray-900 dark:text-gray-100"
  >
    <!-- モーダルを追加 -->
    <div id="settingsModal" class="modal">
      <h2 class="text-xl font-bold mb-4">設定</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">名前</label>
          <input
            type="text"
            id="modalName"
            class="w-full px-4 py-2.5 bg-white dark:bg-discord-darker border border-gray-300 dark:border-gray-600 rounded-lg"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">シード</label>
          <input
            type="text"
            id="modalSeed"
            class="w-full px-4 py-2.5 bg-white dark:bg-discord-darker border border-gray-300 dark:border-gray-600 rounded-lg"
          />
        </div>
        <div class="flex justify-end gap-3">
          <button
            id="saveSettings"
            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
          >
            保存
          </button>
        </div>
      </div>
    </div>
    <div id="modalBackdrop" class="modal-backdrop"></div>
    <div class="flex h-screen">
      <!-- Sidebar -->
      <div class="w-64 bg-discord-sidebar text-white p-4">
        <h1 class="text-xl font-bold mb-4">掲示板</h1>
        <div class="mb-4">
          <select
            id="channel"
            class="w-full px-3 py-2 bg-discord-darker text-white rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
          >
            <option value="main">雑談</option>
            <option value="battle">バトルスタジアム</option>
          </select>
        </div>
        <button
          id="darkModeToggle"
          class="w-full px-4 py-2 bg-discord-darker text-white rounded-md hover:bg-gray-700 transition duration-150"
        >
          ダークモード切替
        </button>
        <button
          id="settingsButton"
          class="w-full px-4 py-2 bg-discord-darker text-white rounded-md hover:bg-gray-700 transition duration-150 mt-2"
        >
          設定
        </button>
      </div>

      <!-- Main content -->
      <div class="flex-1 flex flex-col">
        <div class="flex-1 overflow-hidden">
          <div
            id="topic"
            class="p-4 bg-discord-light dark:bg-discord-darker border-b border-gray-200 dark:border-gray-700"
          ></div>

          <div id="messages" class="message-container p-4 space-y-3"></div>
        </div>

        <div class="message-input-container">
          <div class="max-w-4xl mx-auto flex gap-3">
            <input
              type="text"
              id="message"
              placeholder="メッセージ"
              class="flex-grow px-4 py-2.5 bg-white dark:bg-discord-darker border border-gray-300 dark:border-gray-600 rounded-lg"
            />
            <button
              id="send"
              class="flex-none px-6 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
            >
              送信
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let messageStore = new Map();
      let currentChannel = "main";

      // チャンネル変更時の処理
      document
        .getElementById("channel")
        .addEventListener("change", function (e) {
          currentChannel = e.target.value;
          messageStore.clear(); // メッセージストアをクリア
          const messagesContainer = document.getElementById("messages");
          messagesContainer.innerHTML = ""; // メッセージコンテナをクリア
          fetchMessages(); // 新しいチャンネルのメッセージを取得
        });

      // モーダル関連の処理を追加
      const settingsButton = document.getElementById("settingsButton");
      const settingsModal = document.getElementById("settingsModal");
      const modalBackdrop = document.getElementById("modalBackdrop");
      const saveSettings = document.getElementById("saveSettings");
      const modalName = document.getElementById("modalName");
      const modalSeed = document.getElementById("modalSeed");

      function openModal() {
        settingsModal.style.display = "block";
        modalBackdrop.style.display = "block";
        modalName.value = localStorage.getItem("userName") || "";
        modalSeed.value = localStorage.getItem("userSeed") || "";
      }

      function closeModal() {
        settingsModal.style.display = "none";
        modalBackdrop.style.display = "none";
      }

      settingsButton.addEventListener("click", openModal);
      modalBackdrop.addEventListener("click", closeModal);

      saveSettings.addEventListener("click", () => {
        localStorage.setItem("userName", modalName.value);
        localStorage.setItem("userSeed", modalSeed.value);
        closeModal();
      });

      // ページ読み込み時に設定を復元
      window.addEventListener("load", () => {
        if (!localStorage.getItem("userName")) {
          openModal();
        }
      });

      function createMessageElement(message) {
        const div = document.createElement("div");
        div.id = `message-${message.number}`;
        div.className =
          "message p-4 bg-white dark:bg-discord-dark rounded-lg shadow-sm border border-gray-200 dark:border-gray-700";

        if (
          message.message === "削除されました" &&
          message.name === "削除されました"
        ) {
          div.classList.add("deleted-message");
        }

        const header = document.createElement("div");
        header.className = "flex items-center gap-2 text-sm";

        const numberSpan = document.createElement("span");
        numberSpan.className = "text-gray-500 dark:text-gray-400";
        numberSpan.textContent = `${message.number}:`;

        const nameSpan = document.createElement("span");
        if (message.name_color) {
          nameSpan.style.color = message.name_color;
        }
        nameSpan.className = "font-medium";
        nameSpan.textContent = message.name;

        const idSpan = document.createElement("span");
        if (message.id_color) {
          idSpan.style.color = message.id_color;
        }
        idSpan.className = "text-sm";
        idSpan.textContent = message.user_id || "";

        const extraSpan = document.createElement("span");
        if (message.extra_text) {
          extraSpan.style.color = "magenta";
          extraSpan.className = "text-sm";
          extraSpan.textContent = message.extra_text;
        }

        header.appendChild(numberSpan);
        header.appendChild(nameSpan);
        header.appendChild(idSpan);
        header.appendChild(extraSpan);

        const messageText = document.createElement("div");
        messageText.className =
          "mt-2 text-gray-700 dark:text-gray-300 whitespace-pre-wrap";
        messageText.textContent = message.message;

        div.appendChild(header);
        div.appendChild(messageText);

        return div;
      }

      function updateMessages(data) {
        const topic = document.getElementById("topic");
        topic.textContent = data.topic;

        const messagesContainer = document.getElementById("messages");

        data.messages.reverse().forEach((message) => {
          const existingMessage = messageStore.get(message.number);

          if (!existingMessage) {
            // 新しいメッセージを追加
            const messageElement = createMessageElement(message);
            messagesContainer.appendChild(messageElement);
            messageStore.set(message.number, message);
          } else if (
            message.message === "削除されました" &&
            message.name === "削除されました" &&
            (existingMessage.message !== "削除されました" ||
              existingMessage.name !== "削除されました")
          ) {
            // メッセージが削除された場合
            const messageElement = document.getElementById(
              `message-${message.number}`
            );
            messageElement.classList.add("deleted-message");
            messageStore.set(message.number, message);
          }
        });
      }

      async function fetchMessages() {
        try {
          const response = await fetch(
            `/bbs/api?t=${Date.now()}&channel=${currentChannel}`
          );
          const data = await response.json();
          updateMessages(data);
        } catch (error) {
          console.error("メッセージの取得に失敗しました:", error);
        }
      }

      // 初回読み込みと定期更新
      fetchMessages();
      setInterval(fetchMessages, 5000);

      // スクロール位置の保持
      const messagesContainer = document.getElementById("messages");
      let isScrolledToBottom = true;

      messagesContainer.addEventListener("scroll", () => {
        isScrolledToBottom =
          Math.abs(
            messagesContainer.scrollHeight -
              messagesContainer.scrollTop -
              messagesContainer.clientHeight
          ) < 1;
      });

      const observer = new MutationObserver(() => {
        if (isScrolledToBottom) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      });

      observer.observe(messagesContainer, { childList: true, subtree: true });

      // ダークモードの切り替え
      const darkModeToggle = document.getElementById("darkModeToggle");
      const htmlElement = document.documentElement;

      darkModeToggle.addEventListener("click", () => {
        htmlElement.classList.toggle("dark");
        localStorage.setItem(
          "darkMode",
          htmlElement.classList.contains("dark")
        );
      });

      // ページ読み込み時にダークモードの状態を復元
      if (localStorage.getItem("darkMode") === "true") {
        htmlElement.classList.add("dark");
      }
    </script>
  </body>
</html>
